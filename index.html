<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidFlow - Видеоплатформа</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Все стили остаются такими же как в предыдущем коде */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #ff3c3c;
            --primary-dark: #e60000;
            --dark: #0f0f0f;
            --dark-light: #272727;
            --light: #ffffff;
            --gray: #aaaaaa;
            --transition: all 0.3s ease;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            --radius: 12px;
        }

        body {
            background-color: var(--dark);
            color: var(--light);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .sync-notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            border-radius: var(--radius);
            z-index: 1001;
            display: none;
        }

        .error-notification {
            position: fixed;
            top: 70px;
            left: 20px;
            background: #ff4444;
            color: white;
            padding: 10px 15px;
            border-radius: var(--radius);
            z-index: 1001;
            display: none;
        }

        /* Все остальные стили остаются без изменений */
        /* ... */

    </style>
</head>
<body>
    <!-- Нотификации -->
    <div class="sync-notification" id="syncNotification">
        <i class="fas fa-sync-alt"></i> Синхронизация...
    </div>

    <div class="error-notification" id="errorNotification">
        <i class="fas fa-exclamation-triangle"></i> <span id="errorText"></span>
    </div>

    <!-- Статус синхронизации -->
    <div class="sync-status" id="syncStatus">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span>Локальное хранилище</span>
    </div>

    <div class="storage-info" id="storageInfo">
        <i class="fas fa-database"></i> <span id="storageText">Загрузка...</span>
    </div>

    <!-- Auth Modal -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <div class="logo">
                    <i class="fas fa-play-circle"></i>
                    VidFlow
                </div>
                <p>Войдите в свой аккаунт</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <input type="email" id="loginEmail" placeholder="Email" value="admin@vidflow.com">
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Пароль" value="admin123">
                </div>
                <button class="auth-submit" onclick="login()">Войти</button>
                <div class="auth-switch">
                    Нет аккаунта? <a onclick="showRegister()">Зарегистрироваться</a>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <div class="form-group">
                    <input type="text" id="registerName" placeholder="Имя пользователя">
                </div>
                <div class="form-group">
                    <input type="email" id="registerEmail" placeholder="Email">
                </div>
                <div class="form-group">
                    <input type="password" id="registerPassword" placeholder="Пароль">
                </div>
                <div class="form-group">
                    <input type="password" id="registerConfirm" placeholder="Подтвердите пароль">
                </div>
                <button class="auth-submit" onclick="register()">Зарегистрироваться</button>
                <div class="auth-switch">
                    Есть аккаунт? <a onclick="showLogin()">Войти</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appContainer">
        <!-- Header -->
        <header>
            <div class="logo" onclick="showHomePage()">
                <i class="fas fa-play-circle"></i>
                <span>VidFlow</span>
            </div>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Поиск видео...">
                <button onclick="searchVideos()"><i class="fas fa-search"></i></button>
            </div>
            
            <div class="user-actions">
                <button class="upload-btn" onclick="showUploadModal()">
                    <i class="fas fa-upload"></i> Загрузить
                </button>
                <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">
                    <div class="admin-badge" id="adminBadge" style="display: none;">ADMIN</div>
                </div>
                
                <!-- User Dropdown Menu -->
                <div class="dropdown-menu" id="userDropdown">
                    <div class="dropdown-item" onclick="showProfilePage()">
                        <i class="fas fa-user"></i>
                        <span>Мой канал</span>
                    </div>
                    <div class="dropdown-item" onclick="showMyVideos()">
                        <i class="fas fa-video"></i>
                        <span>Мои видео</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        <span>Экспорт данных</span>
                    </div>
                    <div class="dropdown-item" onclick="importData()">
                        <i class="fas fa-upload"></i>
                        <span>Импорт данных</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="clearStorage()">
                        <i class="fas fa-trash"></i>
                        <span>Очистить кэш</span>
                    </div>
                    <div class="dropdown-item" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Выйти</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li class="active" onclick="showHomePage()"><i class="fas fa-home"></i> Главная</li>
                    <li onclick="showPopular()"><i class="fas fa-fire"></i> Популярное</li>
                    <li onclick="showSubscriptions()"><i class="fas fa-star"></i> Подписки</li>
                    <li onclick="showHistory()"><i class="fas fa-history"></i> История</li>
                    <li onclick="showLiked()"><i class="fas fa-thumbs-up"></i> Понравившиеся</li>
                    <li onclick="showMyVideos()"><i class="fas fa-video"></i> Мои видео</li>
                </ul>
            </aside>

            <!-- Home Page -->
            <main class="main-content" id="homePage">
                <div class="section-title">
                    <h2>Рекомендуемые видео</h2>
                    <button class="action-btn" onclick="loadVideos()">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                </div>
                <div class="video-grid" id="videoGrid">
                    <!-- Videos will be loaded here -->
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="fas fa-video-slash" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h3>Видео пока нет</h3>
                    <p>Будьте первым, кто загрузит видео!</p>
                    <button class="upload-btn" onclick="showUploadModal()" style="margin-top: 1rem;">
                        <i class="fas fa-upload"></i> Загрузить первое видео
                    </button>
                </div>
            </main>

            <!-- Video Player Page -->
            <main class="main-content video-page" id="videoPage">
                <button class="back-btn" onclick="backToVideos()">
                    <i class="fas fa-arrow-left"></i> Назад к видео
                </button>

                <div class="video-player-container">
                    <div class="admin-controls" id="adminControls" style="display: none;">
                        <button class="delete-video-btn" onclick="deleteCurrentVideo()">
                            <i class="fas fa-trash"></i> Удалить видео
                        </button>
                    </div>
                    <div class="video-player">
                        <video id="mainVideo" controls></video>
                    </div>
                    
                    <div class="video-info-page">
                        <h1 class="video-title-page" id="videoTitlePage"></h1>
                        <div class="video-stats-page">
                            <span id="videoViewsPage">0 просмотров</span>
                            <span id="videoDatePage"></span>
                        </div>
                        
                        <div class="video-actions">
                            <button class="action-btn" onclick="likeVideo()"><i class="fas fa-thumbs-up"></i> <span id="likeCount">0</span></button>
                            <button class="action-btn" onclick="dislikeVideo()"><i class="fas fa-thumbs-down"></i> <span id="dislikeCount">0</span></button>
                            <button class="action-btn" onclick="shareVideo()"><i class="fas fa-share"></i> Поделиться</button>
                        </div>
                        
                        <div class="channel-info">
                            <div class="channel-avatar large" id="channelAvatarPage"></div>
                            <div>
                                <h4 id="channelNamePage"></h4>
                                <p id="channelSubsPage">0 подписчиков</p>
                            </div>
                            <button class="subscribe-btn" id="subscribeBtn" onclick="subscribeChannel()">Подписаться</button>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Profile Page -->
            <main class="main-content profile-page" id="profilePage">
                <button class="back-btn" onclick="showHomePage()">
                    <i class="fas fa-arrow-left"></i> Назад
                </button>

                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar" onclick="changeAvatar()"></div>
                    <div class="profile-info">
                        <h1 id="profileName"></h1>
                        <div class="profile-stats">
                            <span id="profileSubs">0 подписчиков</span>
                            <span id="profileVideos">0 видео</span>
                        </div>
                        <button class="edit-profile-btn" onclick="editProfile()">Редактировать канал</button>
                    </div>
                </div>

                <div class="section-title">
                    <h2>Мои видео</h2>
                </div>
                <div class="video-grid" id="profileVideoGrid">
                    <!-- Profile videos will be loaded here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">Загрузить видео</h2>
            
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <p id="uploadText">Нажмите для выбора видео файла</p>
                <p class="file-size-info">Максимальный размер: 100MB</p>
                <input type="file" id="videoFile" accept="video/*" class="file-input">
            </div>

            <div class="form-group">
                <input type="text" id="uploadTitle" placeholder="Название видео">
            </div>
            
            <div class="form-group">
                <textarea id="uploadDescription" placeholder="Описание видео" style="width: 100%; height: 100px; padding: 12px; border: none; border-radius: var(--radius); background: var(--dark); color: var(--light);"></textarea>
            </div>

            <button class="auth-submit" onclick="uploadVideo()">Загрузить видео</button>
            <button class="auth-submit" style="background: var(--dark-light); margin-top: 10px;" onclick="hideUploadModal()">Отмена</button>
        </div>
    </div>

    <!-- Avatar Change Modal -->
    <div class="modal" id="avatarModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">Изменить аватар</h2>
            <div class="upload-area" onclick="document.getElementById('avatarFile').click()">
                <i class="fas fa-user-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <p>Выберите изображение для аватара</p>
                <input type="file" id="avatarFile" accept="image/*" style="display: none;">
            </div>
            <button class="auth-submit" onclick="saveAvatar()">Сохранить аватар</button>
            <button class="auth-submit" style="background: var(--dark-light); margin-top: 10px;" onclick="hideAvatarModal()">Отмена</button>
        </div>
    </div>

    <!-- File Input для импорта -->
    <input type="file" id="importFile" accept=".json" style="display: none;">

    <script>
        // Глобальные переменные
        let users = [];
        let videos = [];
        let currentUser = null;
        let currentPlayingVideo = null;
        let db = null;
        const DB_NAME = 'VidFlowDB';
        const DB_VERSION = 2;

        // DOM elements
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const homePage = document.getElementById('homePage');
        const videoPage = document.getElementById('videoPage');
        const profilePage = document.getElementById('profilePage');
        const videoGrid = document.getElementById('videoGrid');
        const profileVideoGrid = document.getElementById('profileVideoGrid');
        const emptyState = document.getElementById('emptyState');
        const mainVideo = document.getElementById('mainVideo');
        const userAvatar = document.getElementById('userAvatar');
        const userDropdown = document.getElementById('userDropdown');
        const adminBadge = document.getElementById('adminBadge');
        const adminControls = document.getElementById('adminControls');
        const syncNotification = document.getElementById('syncNotification');
        const errorNotification = document.getElementById('errorNotification');
        const errorText = document.getElementById('errorText');
        const storageInfo = document.getElementById('storageInfo');
        const storageText = document.getElementById('storageText');
        const searchInput = document.getElementById('searchInput');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            await initIndexedDB();
            await loadLocalData();
            checkAuth();
            setupEventListeners();
            updateStorageInfo();
        }

        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Создаем хранилище для видео
                    if (!db.objectStoreNames.contains('videos')) {
                        const videoStore = db.createObjectStore('videos', { keyPath: 'id' });
                        videoStore.createIndex('userId', 'userId', { unique: false });
                    }
                    
                    // Создаем хранилище для пользователей
                    if (!db.objectStoreNames.contains('users')) {
                        db.createObjectStore('users', { keyPath: 'id' });
                    }
                    
                    // Создаем хранилище для метаданных
                    if (!db.objectStoreNames.contains('metadata')) {
                        db.createObjectStore('metadata', { keyPath: 'id' });
                    }
                };
            });
        }

        async function loadLocalData() {
            try {
                // Загружаем пользователей из IndexedDB
                const loadedUsers = await getAllFromStore('users');
                if (loadedUsers.length > 0) {
                    users = loadedUsers;
                } else {
                    createDefaultAdmin();
                }

                // Загружаем видео из IndexedDB
                const loadedVideos = await getAllFromStore('videos');
                videos = loadedVideos;

            } catch (error) {
                console.error('Error loading data:', error);
                users = [];
                videos = [];
                createDefaultAdmin();
            }
        }

        function createDefaultAdmin() {
            const adminUser = {
                id: '1',
                username: 'admin',
                email: 'admin@vidflow.com',
                password: 'admin123',
                avatar: '',
                subscribers: 0,
                isAdmin: true,
                joinDate: new Date().toISOString(),
                subscriptions: []
            };
            users.push(adminUser);
            saveToStore('users', adminUser);
        }

        // IndexedDB helper functions
        function saveToStore(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('DB not initialized');
                    return;
                }
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getFromStore(storeName, id) {
            return new Promise((resolve) => {
                if (!db) {
                    resolve(null);
                    return;
                }
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });
        }

        function getAllFromStore(storeName) {
            return new Promise((resolve) => {
                if (!db) {
                    resolve([]);
                    return;
                }
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => resolve([]);
            });
        }

        function deleteFromStore(storeName, id) {
            return new Promise((resolve) => {
                if (!db) {
                    resolve();
                    return;
                }
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => resolve();
            });
        }

        function setupEventListeners() {
            // Video file input
            document.getElementById('videoFile').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    document.getElementById('uploadText').textContent = `Выбран файл: ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`;
                    
                    // Проверка размера файла
                    if (file.size > 100 * 1024 * 1024) { // 100MB limit
                        showError('Файл слишком большой. Максимальный размер: 100MB');
                        e.target.value = '';
                        document.getElementById('uploadText').textContent = 'Нажмите для выбора видео файла';
                    }
                }
            });

            // Search on enter
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchVideos();
                }
            });

            // Click outside dropdown
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-avatar') && !e.target.closest('.dropdown-menu')) {
                    userDropdown.classList.remove('show');
                }
            });
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('vidflow_currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        function showApp() {
            authContainer.style.display = 'none';
            appContainer.style.display = 'block';
            updateUserInterface();
            loadVideos();
        }

        function updateUserInterface() {
            if (currentUser) {
                // Update avatar
                if (currentUser.avatar) {
                    userAvatar.style.backgroundImage = `url(${currentUser.avatar})`;
                    userAvatar.textContent = '';
                } else {
                    userAvatar.style.backgroundImage = '';
                    userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
                }

                // Show admin badge
                if (currentUser.isAdmin) {
                    adminBadge.style.display = 'block';
                }
            }
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = user;
                localStorage.setItem('vidflow_currentUser', JSON.stringify(user));
                showApp();
                showSuccess('Вход выполнен успешно!');
            } else {
                showError('Неверный email или пароль');
            }
        }

        async function register() {
            const username = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;

            if (!username || !email || !password) {
                showError('Заполните все поля');
                return;
            }

            if (password !== confirm) {
                showError('Пароли не совпадают');
                return;
            }

            if (users.find(u => u.email === email)) {
                showError('Пользователь с таким email уже существует');
                return;
            }

            const newUser = {
                id: Date.now().toString(),
                username: username,
                email: email,
                password: password,
                avatar: '',
                subscribers: 0,
                isAdmin: false,
                joinDate: new Date().toISOString(),
                subscriptions: []
            };

            users.push(newUser);
            await saveToStore('users', newUser);
            
            currentUser = newUser;
            localStorage.setItem('vidflow_currentUser', JSON.stringify(newUser));
            showApp();
            showSuccess('Регистрация выполнена успешно!');
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('vidflow_currentUser');
            showAuth();
        }

        function toggleUserMenu() {
            userDropdown.classList.toggle('show');
        }

        function showHomePage() {
            homePage.style.display = 'block';
            videoPage.style.display = 'none';
            profilePage.style.display = 'none';
            loadVideos();
        }

        function showProfilePage() {
            homePage.style.display = 'none';
            videoPage.style.display = 'none';
            profilePage.style.display = 'block';
            renderProfile();
            userDropdown.classList.remove('show');
        }

        async function loadVideos() {
            videos = await getAllFromStore('videos');
            renderVideos();
        }

        function renderVideos() {
            videoGrid.innerHTML = '';
            
            if (videos.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';

            // Сортируем видео по дате загрузки (новые сначала)
            const sortedVideos = [...videos].sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));

            sortedVideos.forEach(video => {
                const videoCard = createVideoCard(video);
                videoGrid.appendChild(videoCard);
            });
        }

        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'video-card';
            card.onclick = () => playVideo(video.id);

            const user = users.find(u => u.id === video.userId);
            const userInitial = user ? user.username.charAt(0).toUpperCase() : 'U';

            card.innerHTML = `
                <div class="thumbnail">
                    <div class="thumbnail-content">
                        <i class="fas fa-play" style="font-size: 2rem; color: white;"></i>
                    </div>
                    ${currentUser && (currentUser.isAdmin || currentUser.id === video.userId) ? 
                        `<button class="delete-btn" onclick="event.stopPropagation(); deleteVideo('${video.id}')">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                </div>
                <div class="video-info">
                    <h3 class="video-title">${video.title}</h3>
                    <div class="video-card-channel">
                        <div class="channel-avatar">${userInitial}</div>
                        <span>${user ? user.username : 'Unknown'}</span>
                    </div>
                    <div class="video-stats">
                        ${video.views || 0} просмотров • ${new Date(video.uploadDate).toLocaleDateString('ru-RU')}
                    </div>
                </div>
            `;

            return card;
        }

        async function playVideo(videoId) {
            const video = videos.find(v => v.id === videoId);
            if (!video) return;

            currentPlayingVideo = video;
            
            // Update video info
            document.getElementById('videoTitlePage').textContent = video.title;
            document.getElementById('videoViewsPage').textContent = `${video.views || 0} просмотров`;
            document.getElementById('videoDatePage').textContent = new Date(video.uploadDate).toLocaleDateString('ru-RU');
            document.getElementById('likeCount').textContent = video.likes || 0;
            document.getElementById('dislikeCount').textContent = video.dislikes || 0;

            const user = users.find(u => u.id === video.userId);
            if (user) {
                document.getElementById('channelNamePage').textContent = user.username;
                document.getElementById('channelSubsPage').textContent = `${user.subscribers || 0} подписчиков`;
                const channelAvatar = document.getElementById('channelAvatarPage');
                if (user.avatar) {
                    channelAvatar.style.backgroundImage = `url(${user.avatar})`;
                    channelAvatar.textContent = '';
                } else {
                    channelAvatar.style.backgroundImage = '';
                    channelAvatar.textContent = user.username.charAt(0).toUpperCase();
                }

                // Update subscribe button
                const subscribeBtn = document.getElementById('subscribeBtn');
                if (currentUser && currentUser.subscriptions && currentUser.subscriptions.includes(user.id)) {
                    subscribeBtn.textContent = 'Отписаться';
                    subscribeBtn.style.background = 'var(--gray)';
                } else {
                    subscribeBtn.textContent = 'Подписаться';
                    subscribeBtn.style.background = 'var(--primary)';
                }
            }

            // Show admin controls
            if (currentUser && (currentUser.isAdmin || currentUser.id === video.userId)) {
                adminControls.style.display = 'block';
            } else {
                adminControls.style.display = 'none';
            }

            // Load video from IndexedDB
            const videoData = await getFromStore('videos', videoId);
            if (videoData && videoData.videoBlob) {
                const blob = new Blob([videoData.videoBlob], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                mainVideo.src = url;
            }

            // Switch to video page
            homePage.style.display = 'none';
            videoPage.style.display = 'block';
            profilePage.style.display = 'none';

            // Increment views
            video.views = (video.views || 0) + 1;
            await saveToStore('videos', video);
            videos = videos.map(v => v.id === videoId ? video : v);
        }

        function backToVideos() {
            homePage.style.display = 'block';
            videoPage.style.display = 'none';
            profilePage.style.display = 'none';
            
            if (mainVideo.src) {
                URL.revokeObjectURL(mainVideo.src);
                mainVideo.src = '';
            }
        }

        function showUploadModal() {
            if (!currentUser) {
                showAuth();
                return;
            }
            document.getElementById('uploadModal').style.display = 'flex';
        }

        function hideUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            // Reset form
            document.getElementById('videoFile').value = '';
            document.getElementById('uploadTitle').value = '';
            document.getElementById('uploadDescription').value = '';
            document.getElementById('uploadText').textContent = 'Нажмите для выбора видео файла';
        }

        function hideAvatarModal() {
            document.getElementById('avatarModal').style.display = 'none';
        }

        async function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            const titleInput = document.getElementById('uploadTitle');
            const descriptionInput = document.getElementById('uploadDescription');
            
            if (!fileInput.files.length) {
                showError('Выберите видео файл');
                return;
            }

            if (!titleInput.value.trim()) {
                showError('Введите название видео');
                return;
            }

            const file = fileInput.files[0];
            const videoId = Date.now().toString();

            try {
                showSyncNotification();
                
                // Read file as ArrayBuffer
                const arrayBuffer = await readFileAsArrayBuffer(file);
                
                // Create video object
                const newVideo = {
                    id: videoId,
                    title: titleInput.value,
                    description: descriptionInput.value,
                    userId: currentUser.id,
                    views: 0,
                    likes: 0,
                    dislikes: 0,
                    uploadDate: new Date().toISOString(),
                    videoBlob: arrayBuffer
                };

                // Save to IndexedDB
                await saveToStore('videos', newVideo);
                videos.push(newVideo);
                
                hideUploadModal();
                loadVideos();
                showSuccess('Видео успешно загружено!');
                
            } catch (error) {
                showError('Ошибка при загрузке видео: ' + error.message);
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function deleteVideo(videoId) {
            if (!confirm('Вы уверены, что хотите удалить это видео?')) return;

            const videoIndex = videos.findIndex(v => v.id === videoId);
            if (videoIndex === -1) return;

            videos.splice(videoIndex, 1);
            await deleteFromStore('videos', videoId);
            
            loadVideos();
            showSuccess('Видео удалено');
        }

        function deleteCurrentVideo() {
            if (currentPlayingVideo) {
                deleteVideo(currentPlayingVideo.id);
                backToVideos();
            }
        }

        async function renderProfile() {
            if (!currentUser) return;

            document.getElementById('profileName').textContent = currentUser.username;
            document.getElementById('profileSubs').textContent = `${currentUser.subscribers || 0} подписчиков`;
            
            const userVideos = videos.filter(v => v.userId === currentUser.id);
            document.getElementById('profileVideos').textContent = `${userVideos.length} видео`;

            // Update avatar
            const profileAvatar = document.getElementById('profileAvatar');
            if (currentUser.avatar) {
                profileAvatar.style.backgroundImage = `url(${currentUser.avatar})`;
                profileAvatar.textContent = '';
            } else {
                profileAvatar.style.backgroundImage = '';
                profileAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            }

            // Render profile videos
            profileVideoGrid.innerHTML = '';
            userVideos.forEach(video => {
                const videoCard = createVideoCard(video);
                profileVideoGrid.appendChild(videoCard);
            });
        }

        function changeAvatar() {
            document.getElementById('avatarModal').style.display = 'flex';
        }

        async function saveAvatar() {
            const fileInput = document.getElementById('avatarFile');
            if (!fileInput.files.length) {
                showError('Выберите изображение');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async function(e) {
                currentUser.avatar = e.target.result;
                
                // Update in users array and IndexedDB
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex].avatar = e.target.result;
                    await saveToStore('users', currentUser);
                }
                
                localStorage.setItem('vidflow_currentUser', JSON.stringify(currentUser));
                
                updateUserInterface();
                document.getElementById('avatarModal').style.display = 'none';
                showSuccess('Аватар обновлен');
            };
            reader.readAsDataURL(file);
        }

        async function likeVideo() {
            if (!currentPlayingVideo) return;
            currentPlayingVideo.likes = (currentPlayingVideo.likes || 0) + 1;
            await saveToStore('videos', currentPlayingVideo);
            document.getElementById('likeCount').textContent = currentPlayingVideo.likes;
        }

        async function dislikeVideo() {
            if (!currentPlayingVideo) return;
            currentPlayingVideo.dislikes = (currentPlayingVideo.dislikes || 0) + 1;
            await saveToStore('videos', currentPlayingVideo);
            document.getElementById('dislikeCount').textContent = currentPlayingVideo.dislikes;
        }

        function shareVideo() {
            if (!currentPlayingVideo) return;
            
            const shareUrl = window.location.href.split('?')[0];
            navigator.clipboard.writeText(shareUrl).then(() => {
                showSuccess('Ссылка на видео скопирована в буфер обмена');
            });
        }

        async function subscribeChannel() {
            if (!currentPlayingVideo || !currentUser) return;
            
            const videoUser = users.find(u => u.id === currentPlayingVideo.userId);
            if (videoUser && videoUser.id !== currentUser.id) {
                if (!currentUser.subscriptions) {
                    currentUser.subscriptions = [];
                }

                const isSubscribed = currentUser.subscriptions.includes(videoUser.id);
                
                if (isSubscribed) {
                    // Unsubscribe
                    currentUser.subscriptions = currentUser.subscriptions.filter(id => id !== videoUser.id);
                    videoUser.subscribers = Math.max(0, (videoUser.subscribers || 0) - 1);
                    document.getElementById('subscribeBtn').textContent = 'Подписаться';
                    document.getElementById('subscribeBtn').style.background = 'var(--primary)';
                    showSuccess(`Вы отписались от ${videoUser.username}`);
                } else {
                    // Subscribe
                    currentUser.subscriptions.push(videoUser.id);
                    videoUser.subscribers = (videoUser.subscribers || 0) + 1;
                    document.getElementById('subscribeBtn').textContent = 'Отписаться';
                    document.getElementById('subscribeBtn').style.background = 'var(--gray)';
                    showSuccess(`Вы подписались на ${videoUser.username}`);
                }

                // Save changes
                await saveToStore('users', currentUser);
                await saveToStore('users', videoUser);
                localStorage.setItem('vidflow_currentUser', JSON.stringify(currentUser));
                
                document.getElementById('channelSubsPage').textContent = `${videoUser.subscribers} подписчиков`;
            }
        }

        function showMyVideos() {
            const myVideos = videos.filter(v => v.userId === currentUser.id);
            renderFilteredVideos(myVideos, 'Мои видео');
        }

        function showPopular() {
            const popularVideos = [...videos].sort((a, b) => (b.views || 0) - (a.views || 0));
            renderFilteredVideos(popularVideos.slice(0, 20), 'Популярные видео');
        }

        function showSubscriptions() {
            if (!currentUser || !currentUser.subscriptions || currentUser.subscriptions.length === 0) {
                videoGrid.innerHTML = '<div class="empty-state"><h3>Вы еще ни на кого не подписаны</h3></div>';
                return;
            }
            
            const subscriptionVideos = videos.filter(v => currentUser.subscriptions.includes(v.userId));
            renderFilteredVideos(subscriptionVideos, 'Подписки');
        }

        function showHistory() {
            // В реальном приложении здесь была бы история просмотров
            showHomePage();
        }

        function showLiked() {
            // В реальном приложении здесь были бы понравившиеся видео
            showHomePage();
        }

        function renderFilteredVideos(filteredVideos, title) {
            document.querySelector('.section-title h2').textContent = title;
            videoGrid.innerHTML = '';
            
            if (filteredVideos.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            filteredVideos.forEach(video => {
                const videoCard = createVideoCard(video);
                videoGrid.appendChild(videoCard);
            });
        }

        function searchVideos() {
            const query = searchInput.value.toLowerCase().trim();
            if (!query) {
                loadVideos();
                return;
            }

            const filteredVideos = videos.filter(video => 
                video.title.toLowerCase().includes(query) ||
                video.description.toLowerCase().includes(query)
            );

            renderFilteredVideos(filteredVideos, `Результаты поиска: "${query}"`);
        }

        function showSyncNotification() {
            syncNotification.style.display = 'block';
            setTimeout(() => {
                syncNotification.style.display = 'none';
            }, 2000);
        }

        function showError(message) {
            errorText.textContent = message;
            errorNotification.style.display = 'block';
            setTimeout(() => {
                errorNotification.style.display = 'none';
            }, 3000);
        }

        function showSuccess(message) {
            // Можно добавить уведомление об успехе
            console.log('Success:', message);
            // Временное уведомление
            alert(message);
        }

        async function clearStorage() {
            if (confirm('Вы уверены, что хотите очистить все данные? Это удалит все видео и аккаунты.')) {
                try {
                    // Clear IndexedDB
                    const stores = ['videos', 'users', 'metadata'];
                    for (const storeName of stores) {
                        const transaction = db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        await store.clear();
                    }
                    
                    // Clear localStorage
                    localStorage.clear();
                    
                    showSuccess('Все данные очищены');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } catch (error) {
                    showError('Ошибка при очистке данных');
                }
            }
        }

        async function exportData() {
            try {
                const exportData = {
                    users: users,
                    videos: videos.map(v => ({
                        ...v,
                        videoBlob: undefined // Не экспортируем большие blob-объекты
                    })),
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `vidflow-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('Данные экспортированы');
            } catch (error) {
                showError('Ошибка при экспорте данных');
            }
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        document.getElementById('importFile').addEventListener('change', async function(e) {
            if (e.target.files.length === 0) return;
            
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(event) {
                try {
                    const importData = JSON.parse(event.target.result);
                    
                    if (!importData.users || !importData.videos) {
                        throw new Error('Неверный формат файла');
                    }
                    
                    if (confirm('Это перезапишет все текущие данные. Продолжить?')) {
                        // Clear existing data
                        const stores = ['videos', 'users'];
                        for (const storeName of stores) {
                            const transaction = db.transaction([storeName], 'readwrite');
                            const store = transaction.objectStore(storeName);
                            await store.clear();
                        }
                        
                        // Import users
                        for (const user of importData.users) {
                            await saveToStore('users', user);
                        }
                        
                        // Import videos
                        for (const video of importData.videos) {
                            await saveToStore('videos', video);
                        }
                        
                        users = importData.users;
                        videos = importData.videos;
                        
                        showSuccess('Данные успешно импортированы');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                } catch (error) {
                    showError('Ошибка при импорте данных: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            e.target.value = ''; // Reset input
        });

        async function updateStorageInfo() {
            try {
                let totalSize = 0;
                const allVideos = await getAllFromStore('videos');
                
                allVideos.forEach(video => {
                    if (video.videoBlob) {
                        totalSize += video.videoBlob.byteLength || 0;
                    }
                });
                
                const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
                const videoCount = allVideos.length;
                storageText.textContent = `${videoCount} видео, ${sizeInMB} MB`;
            } catch (error) {
                console.error('Error updating storage info:', error);
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // Demo data for first time users
        async function createDemoData() {
            if (videos.length === 0 && users.length <= 1) {
                // Create demo user
                const demoUser = {
                    id: '2',
                    username: 'DemoCreator',
                    email: 'demo@vidflow.com',
                    password: 'demo123',
                    avatar: '',
                    subscribers: 15,
                    isAdmin: false,
                    joinDate: new Date().toISOString(),
                    subscriptions: []
                };
                users.push(demoUser);
                await saveToStore('users', demoUser);
                
                showSuccess('Демо данные созданы! Используйте admin@vidflow.com / admin123 для входа');
            }
        }

        // Initialize demo data after app load
        setTimeout(createDemoData, 1000);
    </script>
</body>
</html>
